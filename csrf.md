# CSRF (Cross-Site Request Forgery)

<br />
<br />

* CSRF 공격
---

```
사용자가 인증된 상태에서 의도하지 않은 요청을 악의적인 웹사이트가 보내도록 유도하는 공격이다.
즉, 공격자는 피해자가 이미 로그인한 웹사이트에 대해 악성 요청을 보냄으로써
피해자가 원하지 않는 행동을 수행하게 만든다.
```

<br />
<br />
<br />
<br />

1. 피해 과정

<br />

`1) 피해자 웹사이트에 사용자가 로그인한 상태에서 브라우저 세션이 유지된다.`

`2) 공격자 웹사이트에서 피해자가 의도치 않게 요청을 보내도록 유도한다.`

`3) 피해자의 브라우저는 이미 로그인한 상태이기 때문에, 자동으로 세션 쿠키를 포함하여 공격자 웹사이트에서 보낸 요청을 처리한다.`

`4) 피해자는 자신의 의도와 상관없이 웹사이트에 대한 악성 요청을 보내게 되어, 서버는 이를 정상적인 요청으로 처리한다.`

<br />
<br />
<br />

2. 공격 패턴

<br />

`1) 피해자 로그인 (정상적인 상황)`

```
피해자가 A 웹사이트에 로그인하면,
세션 쿠키(예: session_id=abcd1234)가 브라우저에 저장된다.
(이 쿠키는 이후 모든 요청에 자동으로 포함된다.)
```

<br />

`2) 공격자의 악성 웹사이트 공격`

```
공격자는 피해자에게 A 웹사이트에서 계좌 이체를 실행하는 악성 요청을 포함한 HTML 페이지를 보낸다.

예를 들어, 공격자는 이메일이나 포럼, 또는 다른 방법으로 다음과 같은 링크를 피해자에게 전송할 수 있다.
```

<br />

`3) 피해 발생`

```
피해자가 공격자의 웹사이트를 방문하면, 
페이지가 로드될 때 <img> 태그가 실행된다.

이는 HTTP GET 요청을 http://csrf.com/transfer URL로 보낸다.

피해자는 의도치 않게 to_account=attacker_account 로 1000원을 송금하는 요청을 보내게 된다.

이때 중요한 점은 피해자의 브라우저가 이미 로그인된 상태이므로, 
이 요청에는 자동으로 세션 쿠키가 포함되어 있어
서버는 이를 정상적인 사용자 요청으로 간주하고 계좌 이체를 실행한다.
```

```html
<!-- 코드 예시 -->

<img src="http://csrf.com/transfer?amount=1000&to_account=attacker_account" />
```

<br />
<br />
<br />

3. 공격 방어

<br />

`1) CSRF 토큰 사용`

```
웹 애플리케이션에서 모든 상태 변경 요청(예: 폼 제출, 계좌 이체 등)에는 CSRF 토큰을 포함한다.

CSRF 토큰은 서버에서 생성하고, 클라이언트(사용자 페이지)에서 이 토큰을 요청과 함께 전송한다.
(서버는 이 토큰을 확인하고, 유효한 토큰이 아닌 경우 요청을 차단합니다.)
```

```html
<!-- 코드 예시 -->

<form action="http://csrf.com/transfer" method="POST">
  <input type="text" name="amount" value="1000" />
  <input type="text" name="to_account" value="attacker_account" />
  <input type="hidden" name="csrf_token" value="unique_token_from_server" />
  <button type="submit">Transfer</button>
</form>
```

<br />

`2) Referer 헤더 확인`

```
서버는 Referer 헤더를 확인하여 요청이 동일한 도메인에서 왔는지 검증할 수 있다.

공격자는 다른 도메인에서 요청을 보낼 수 없으므로,
Referer 헤더가 올바르지 않으면 요청을 거부할 수 있다.
```

<br />

`3) GET 요청을 상태 변경에 사용하지 않기`

```
GET 요청은 원래 상태를 변경하지 않는 요청이어야 한다.

상태 변경을 발생시키는 작업은 항상 POST, PUT, DELETE 등의 안전한 HTTP 메소드를 사용해야 하며,
이를 통해 CSRF 공격 가능성을 줄일 수 있다.
```
